(function(h){h.fn.jqwiz=function(f){function Z(){z="start";t=false;for(var a=h('<ul class="quizList">'),d=0,b;b=B[d++];)h("<li>").data({gid:b.gid,key:b.key}).html(b.title+'<div class="icon"></div>').appendTo(a);l.fadeOut(J,function(){n.addClass("listView");w.show();T.show();x.addClass("disabled").hide();u.addClass("disabled").hide();o.addClass("disabled").hide();K.hide();D.hide();l.html(h("<div>").append(a)).fadeIn(L).trigger("enable-list")}).trigger("reset-timer")}function $(){if(t&&c.options.quickfire){t=
false;C(f.key,f.gid)}else{z="next";M=t=false;p=c.questions.length;N=O=j=0;q=[];l.fadeOut(J,function(){w.show();n.removeClass("listView");T.hide();B.length?x.removeClass("disabled").show():x.addClass("disabled").show();u.addClass("disabled");o.removeClass("disabled");K.html(P(c.options.time?c.options.time:0)).show();D.html(p).show();l.html(h("<div><h3>"+c.title+'</h3><div class="quizMessage">'+c.description+'</div><div class="quizStart">Start</div></div>')).fadeIn(L).trigger("external-links")}).trigger("disable-list").trigger("reset-timer")}}
function aa(a){z==="mark"&&l.find("li.select").length&&da();a?j++:--j;if(j>0&&j<=p){z="mark";if(c.questions[j-1]){a=c.questions[j-1];for(var d=h("<div>").append(h("<h3>").html(a.text)),b=h('<ul class="quizList">'),e=0,k=a.answers.length;e<k;e++){var g=a.answers[e];if(q[j-1]!==undefined){z="next";var y=(e===q[j-1]?"select ":"")+(g.correct?"isRight":"isWrong");h("<li>").data("correct",g.correct).addClass(y).html(g.text+'<div class="icon"></div>').appendTo(b)}else h("<li>").data("correct",g.correct).html(g.text+
'<div class="icon"></div>').appendTo(b)}d.append(b);l.fadeOut(J,function(){D.html(j+"/"+p);j-1?u.removeClass("disabled"):u.addClass("disabled");o.removeClass("disabled");l.empty().append(d).fadeIn(L,function(){if(j===1&&q.length===0){U();B.length||x.removeClass("disabled")}else M&&!t&&V()}).trigger("external-links");t||l.trigger("enable-list")}).trigger("disable-list")}}else V()}function da(){z="next";if(!q[j-1]){var a=true;answer=-1;l.find("li").each(function(d){var b=h(this),e=b.data("correct");
b.addClass(e?"isRight":"isWrong");if(b.hasClass("select")){answer=d;N++;a=a==e}});a&&O++;q[j-1]=answer}}function V(){z="finish";if(!t)if(c.options.quickfire){for(var a=[],d=[],b=0,e=q.length;b<e;b++)if(q[b]!==undefined){a.push(c.questions[b]);d.push(q[b])}c.questions=a;q=d;j=p=q.length;D.html(j++ +"/"+p)}else{j=N?j:p+1;for(b=0;b<p;b++)if(q[b]===undefined)q[b]=-1}var k='<div><div class="quizResults"><h3>'+A[f.lang].score+": "+(p?Math.round(O/p*100):0)+"%</h3><ul><li>"+A[f.lang].answered+": "+N+"/"+
p+"</li><li>"+A[f.lang].correct+": "+O+"/"+p+"</li><li>"+(M?A[f.lang]["time-expired"]+": ("+Q+")":A[f.lang].time+": "+Q)+'</li></ul></div><div class="quizMessage">'+c.message+"</div></div>";l.fadeOut(J,function(){p?u.removeClass("disabled"):u.addClass("disabled");o.addClass("disabled");l.empty().append(h(k)).fadeIn(L,function(){t=true}).trigger("external-links")}).trigger("disable-list").trigger("reset-timer")}function U(){var a=new Date;E||(E=a.getHours()*60*60+a.getMinutes()*60+a.getSeconds()+c.options.time);
a=a.getHours()*60*60+a.getMinutes()*60+a.getSeconds();a=c.options.time?E-a:a-E;Q=P(c.options.time?c.options.time-a:a);K.html(P(a));if(!t)if(c.options.time)if(a>0)W[1]=setTimeout(U,250);else{M=true;Q=P(c.options.time);V()}else W[1]=setTimeout(U,250)}function C(a,d){var b=encodeURIComponent("https://spreadsheets.google.com/pub?key="+a+"&gid="+d+"&output=csv&single=true");b="http://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent('select * from csv where url="')+b+'"&format=json&callback=?';
var e=setTimeout(function(){m.trigger("jqwiz-error","Unable to process request at this time")},22E3),k=function(g){try{clearTimeout(e);if(g.query.count){i=g.query.results.row;F=i.length;var y=i[0].col0.toLowerCase()==="gid",v=y?i[0]:i[2];G=0;for(var r in v)v.hasOwnProperty(r)&&G++;H[a][d]=g;if(y)if(F>1&&G>1)try{B=[];for(g=1;g<F;g++)B.push({gid:parseInt(s(i[g].col0)),key:s(i[g].col1)||f.key,title:s(i[g].col2),description:s(i[g].col3)});Z()}catch(R){m.trigger("jqwiz-error","Parsing quiz list")}else m.trigger("jqwiz-error",
"Invalid quiz list data");else ea(a,d)}else m.trigger("jqwiz-error","No quiz data")}catch(fa){ba++?m.trigger("jqwiz-error","Processing quiz data"):C(a,d)}};H[a]=f.cache?H[a]||[]:[];if(!f.cache||f.cache&&!H[a][d]){m.trigger("spinner-show");h.ajax({url:b,context:m,success:k,error:function(g){clearTimeout(e);m.trigger("spinner-hide");g.status===401||g.status===403||(g.status===504&&!ba++?C(a,d):m.trigger("jqwiz-error","Unable to load quiz ("+g.status+")"))},complete:function(){m.trigger("spinner-hide")},
dataType:"json",timeout:2E4,global:false,cache:true})}else k(H[a][d])}function ea(a,d){function b(I){for(var S=I.length;--S;){var ca=Math.floor(Math.random()*(S+1)),ga=I[S];I[S]=I[ca];I[ca]=ga}}if(F>3&&G>3)try{c={title:s(i[1].col0),description:s(i[1].col1),message:s(i[1].col2),options:{time:0,random:false,questions:0,quickfire:false,mark:true},questions:[],key:a,gid:d};if(i[1].col3){for(var e=s(i[1].col3).split(","),k=0,g;g=e[k++];){var y=g.split("=");if(y.length==2){a=h.trim(s(y[0]));var v=h.trim(s(y[1])).toLowerCase();
if(isNaN(v)){if(v=="true"||v=="false")v=v=="true"}else v=parseInt(v);c.options[a]=v}}if(typeof c.options.time==="string"){var r=c.options.time.split(":");e=0;switch(r.length){case 3:e=parseInt(r[0])*60*60+parseInt(r[1])*60+parseInt(r[2]);break;case 2:e=parseInt(r[0])*60+parseInt(r[1]);break;default:e=0}c.options.time=e}}for(k=3;k<F;k++)if(i[k].col1){var R={text:s(i[k].col0),answers:[{text:s(i[k].col1),correct:true}]};for(r=2;r<G;r++)i[k]["col"+r]&&R.answers.push({text:s(i[k]["col"+r]),correct:false});
b(R.answers);c.questions.push(R)}c.options.random&&b(c.questions);if(c.options.questions&&c.options.questions<c.questions.length)c.questions=c.questions.slice(0,c.options.questions);$()}catch(fa){m.trigger("jqwiz-error","Parsing quiz questions")}else m.trigger("jqwiz-error","Invalid quiz question data")}function s(a){return a?a.replace(/""/g,'"').replace(/^"|"$/g,"").replace(/(^((https?):\/)?\/?([^:\/\s]+)((\/\w+)*\/)([\w\-\.]+\.(png|jpg|gif))$)/gi,'<img src="$1"/>'):""}function P(a){a=a<0?0:a;var d=
Math.floor(a/3600),b=Math.floor((a-d*3600)/60);a=a-d*3600-b*60;d=d?d+":":"";b=b<10?"0"+b:b;a=a<10?"0"+a:a;return d+b+":"+a}h.fn.jqwiz.defaults={title:"jqwiz",key:"0ApY46l664W_jdFY1SDZGanF4ellYSzVxZzZ0QVFkSEE",gid:0,lang:"en",oneclick:true,cache:true};f=h.extend({},h.fn.jqwiz.defaults,f);var m=h(this),X,n,w,T,x,K,l,u,D,o,Y,H={},i=[],F=0,G=0,ba=0,t=false,M=false,z="start",B=[],c={},E=0,Q=0,W=[],p=0,j=0,O=0,N=0,q=[],J=700,L=300,A={en:{answered:"Answered",correct:"Correct",loading:"Loading",start:"Start",
score:"Score",time:"Time","time-expired":"Time Expired"},jp:{answered:"\u56de\u7b54",correct:"\u6b63\u3057\u3044",loading:"\u30ed\u30fc\u30c9",start:"\u958b\u59cb",score:"\u30b9\u30b3\u30a2",time:"\u6642\u9593","time-expired":"\u6642\u9593\u304c\u671f\u9650\u5207\u308c"}};(function(){if(window.location.search)for(var a=window.location.search.replace("?","").split("&"),d=0,b;b=a[d++];){b=b.split("=");if(b.length===2)f[b[0].toLowerCase()]=b[1]}f.lang=A[f.lang]?f.lang:"en";h('<div class="quizWrapper"><div class="quizContainer listView"><div class="quizHeader"><h2>'+
f.title+'</h2><div class="quizBack disabled"></div><div class="quizTime"></div><div class="quizCount"></div><div class="quizPrev disabled"></div><div class="quizNext disabled"></div></div><div class="quizContent"></div></div><div class="quizSpinner">'+A[f.lang].loading+"</div></div>").appendTo(m);X=m.find(".quizWrapper");n=X.find(".quizContainer");w=n.find(".quizHeader");T=w.find("h2");x=w.find(".quizBack");K=w.find(".quizTime");D=w.find(".quizCount");u=w.find(".quizPrev");o=w.find(".quizNext");l=
n.find(".quizContent");Y=X.find(".quizSpinner");n.bind("enable-list",function(){l.delegate("li","click",function(){var e=h(this);if(n.hasClass("listView"))e.data()?C(e.data("key"),e.data("gid")):C(f.key,f.gid);else if(e.hasClass("select"))o.trigger("click");else{l.find("li").removeClass("select");e.addClass("select");f.oneclick?o.trigger("click"):o.attr("disabled",false)}return false})});n.bind("disable-list",function(){l.undelegate("li","click")});n.delegate(".quizStart","click",function(){o.trigger("click");
return false});x.bind("click",function(){if(!x.hasClass("disabled")){x.addClass("disabled");B.length?Z():$()}return false});u.bind("click",function(){if(!u.hasClass("disabled")){u.addClass("disabled");aa(false)}return false});o.bind("click",function(){if(!o.hasClass("disabled")){o.addClass("disabled");aa(true)}return false});n.bind("swipeleft",function(){t&&u.trigger("click")});n.bind("swiperight",function(){t&&o.trigger("click")});n.bind("external-links",function(){l.find("a").attr("target","_blank")});
n.bind("reset-timer",function(){E=null;clearTimeout(W[1])});m.bind("spinner-show",function(){Y.show()});m.bind("spinner-hide",function(){Y.hide()});m.bind("jqwiz-error",function(e,k){l.empty().html('<div class="quizError">Error: '+k+"</div>").trigger("spinner-hide")});C(f.key,f.gid)})();return this}})(jQuery);